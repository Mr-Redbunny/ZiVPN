<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZiVPN Multi-Server Manager</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f0f2f5;
            --text-color: #333;
            --sidebar-bg: #fff;
            --card-bg: #fff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-color: #e0e0e0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .app-layout {
            display: flex;
            height: 100vh;
        }
        #sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }
        #sidebar h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
        }
        #sidebar .server-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        #sidebar .server-list li {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        #sidebar .server-list li:hover {
            background-color: #f0f2f5;
        }
        #sidebar .server-list li.active {
            background-color: var(--primary-color);
            color: white;
        }
        #main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            color: var(--primary-color);
        }
        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-sm { padding: 8px 14px; font-size: 14px; width: auto; margin: 0 5px; }

        #dashboard-view { display: none; }
        #server-manager-view .server-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #server-manager-view .server-item h3 { margin: 0; color: #333; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border-color); text-align: left; }
        th { background-color: #f8f9fa; }

        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="password"], input[type="number"] {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box;
        }
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333;
            color: white; padding: 15px 20px; border-radius: 8px; box-shadow: var(--shadow); z-index: 1000;
            opacity: 0; transition: all 0.5s;
        }
        .toast.show { opacity: 1; transform: translate(-50%, -10px); }
    </style>
</head>
<body>

<div class="app-layout">
    <div id="sidebar" style="display: none;">
        <h2>Servers</h2>
        <ul class="server-list" id="sidebar-server-list">
            <!-- Server list will be populated by JS -->
        </ul>
        <button id="manage-servers-btn" class="btn btn-secondary">Manage Servers</button>
    </div>

    <div id="main-content">
        <div class="container">
            <!-- Server Manager View (Initial View) -->
            <div id="server-manager-view">
                <div class="card">
                    <h1>ZiVPN Server Manager</h1>
                    <p>Add a server to get started or connect to an existing one.</p>
                    <div id="manager-server-list"></div>
                    <button id="show-add-server-modal-btn" class="btn" style="margin-top: 20px;">Add New Server</button>
                </div>
            </div>

            <!-- Dashboard View (After Connecting) -->
            <div id="dashboard-view">
                 <div class="card">
                    <h2 id="dashboard-title">Server Info</h2>
                    <div id="server-info"></div>
                </div>
                <div class="card">
                    <h2>User Management</h2>
                    <button id="show-add-user-modal-btn" class="btn">Add New User</button>
                    <div id="user-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Server Modal -->
<div id="server-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-server-modal">&times;</span>
        <h2 id="server-modal-title">Add New Server</h2>
        <input type="hidden" id="server-id">
        <div class="form-group">
            <label for="server-name">Server Name</label>
            <input type="text" id="server-name" placeholder="e.g., VPS Singapore">
        </div>
        <div class="form-group">
            <label for="server-domain">Domain / IP</label>
            <input type="text" id="server-domain" placeholder="e.g., vpn.domain.com or 1.2.3.4">
        </div>
        <div class="form-group">
            <label for="server-api-key">API Key</label>
            <input type="password" id="server-api-key" placeholder="Enter API Key">
        </div>
        <button id="save-server-btn" class="btn">Save Server</button>
    </div>
</div>

<!-- Add/Renew User Modal -->
<div id="user-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-user-modal">&times;</span>
        <h2 id="user-modal-title">Add New User</h2>
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="Enter username">
        </div>
        <div class="form-group">
            <label for="days">Days</label>
            <input type="number" id="days" placeholder="e.g., 30">
        </div>
        <button id="save-user-btn" class="btn">Save</button>
    </div>
</div>

<div id="toast-notification" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let state = {
        servers: [],
        activeServerId: null,
    };

    // --- DOM ELEMENTS ---
    const serverManagerView = document.getElementById('server-manager-view');
    const dashboardView = document.getElementById('dashboard-view');
    const sidebar = document.getElementById('sidebar');
    const managerServerListDiv = document.getElementById('manager-server-list');
    const sidebarServerListUl = document.getElementById('sidebar-server-list');
    const toast = document.getElementById('toast-notification');

    // Server Modal
    const serverModal = document.getElementById('server-modal');
    const serverModalTitle = document.getElementById('server-modal-title');
    const closeServerModalBtn = document.getElementById('close-server-modal');
    const saveServerBtn = document.getElementById('save-server-btn');
    const serverIdInput = document.getElementById('server-id');
    const serverNameInput = document.getElementById('server-name');
    const serverDomainInput = document.getElementById('server-domain');
    const serverApiKeyInput = document.getElementById('server-api-key');

    // --- LOCALSTORAGE ---
    const getServers = () => JSON.parse(localStorage.getItem('zivpn_servers')) || [];
    const saveServers = (servers) => localStorage.setItem('zivpn_servers', JSON.stringify(servers));

    // --- UI FUNCTIONS ---
    function showToast(message, duration = 3000) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    function setButtonLoading(button, isLoading, text) {
        button.disabled = isLoading;
        button.textContent = text;
    }

    // --- SERVER MANAGEMENT LOGIC ---
    function renderServerManagerList() {
        const servers = getServers();
        if (servers.length === 0) {
            managerServerListDiv.innerHTML = '<p>No servers added yet. Click "Add New Server" to begin.</p>';
            return;
        }

        managerServerListDiv.innerHTML = servers.map(server => `
            <div class="server-item">
                <div>
                    <h3>${server.name}</h3>
                    <span>${server.domain}</span>
                </div>
                <div>
                    <button class="btn btn-sm" onclick="connectToServer('${server.id}')">Connect</button>
                    <button class="btn btn-sm btn-secondary" onclick="openServerModal(true, '${server.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteServer('${server.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function openServerModal(isEdit = false, serverId = null) {
        serverIdInput.value = '';
        serverNameInput.value = '';
        serverDomainInput.value = '';
        serverApiKeyInput.value = '';

        if (isEdit && serverId) {
            const server = getServers().find(s => s.id === serverId);
            if (server) {
                serverModalTitle.textContent = 'Edit Server';
                serverIdInput.value = server.id;
                serverNameInput.value = server.name;
                serverDomainInput.value = server.domain;
                serverApiKeyInput.value = server.apiKey;
            }
        } else {
            serverModalTitle.textContent = 'Add New Server';
        }
        serverModal.style.display = 'flex';
    }

    function closeServerModal() {
        serverModal.style.display = 'none';
    }

    function saveServer() {
        const id = serverIdInput.value;
        const name = serverNameInput.value.trim();
        const domain = serverDomainInput.value.trim();
        const apiKey = serverApiKeyInput.value.trim();

        if (!name || !domain || !apiKey) {
            showToast('All fields are required.');
            return;
        }

        let servers = getServers();
        if (id) { // Editing existing server
            servers = servers.map(s => s.id === id ? { ...s, name, domain, apiKey } : s);
        } else { // Adding new server
            servers.push({ id: `srv_${Date.now()}`, name, domain, apiKey });
        }

        saveServers(servers);
        showToast(id ? 'Server updated successfully!' : 'Server added successfully!');
        renderServerManagerList();
        closeServerModal();
    }

    window.deleteServer = function(serverId) {
        if (confirm('Are you sure you want to delete this server?')) {
            let servers = getServers().filter(s => s.id !== serverId);
            saveServers(servers);
            showToast('Server deleted.');
            renderServerManagerList();
        }
    }

    // --- EVENT LISTENERS ---
    document.getElementById('show-add-server-modal-btn').addEventListener('click', () => openServerModal(false));
    closeServerModalBtn.addEventListener('click', closeServerModal);
    saveServerBtn.addEventListener('click', saveServer);

    window.onclick = function(event) {
        if (event.target == serverModal) {
            closeServerModal();
        }
        if (event.target == userModal) {
            userModal.style.display = 'none';
        }
    }

    // --- API & CONNECTION LOGIC ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        const server = getServers().find(s => s.id === state.activeServerId);
        if (!server) {
            showToast('No active server selected.');
            return null;
        }

        // Use HTTPS for secure API calls, assuming Nginx reverse proxy handles SSL
        const url = `https://${server.domain}${endpoint}`;
        const headers = { 'Content-Type': 'application/json', 'X-API-Key': server.apiKey };

        try {
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(url, options);

            if (response.status === 401) {
                showToast(`Unauthorized for ${server.name}. Check API Key.`);
                switchToManagerView();
                return null;
            }
            if (!response.ok) {
                showToast(`Error connecting to ${server.name}: ${response.statusText}`);
                return null;
            }
            return await response.json();
        } catch (error) {
            showToast(`Connection failed for ${server.name}. Check domain/IP and network.`);
            return null;
        }
    }

    window.connectToServer = async function(serverId) {
        // Find the button in the manager list to show loading state
        const connectBtn = document.querySelector(`.server-item button[onclick="connectToServer('${serverId}')"]`);
        if (connectBtn) setButtonLoading(connectBtn, true, 'Connecting...');

        state.activeServerId = serverId;
        const server = getServers().find(s => s.id === serverId);
        showToast(`Connecting to ${server.name}...`);

        const info = await apiCall('/api/info');

        if (connectBtn) setButtonLoading(connectBtn, false, 'Connect');

        if (info && info.success) {
            showToast(`Connected to ${server.name}!`);
            switchToDashboardView();
            loadDashboardData();
        } else {
            state.activeServerId = null;
        }
    }

    function switchToDashboardView() {
        renderSidebarServerList();
        serverManagerView.style.display = 'none';
        dashboardView.style.display = 'block';
        sidebar.style.display = 'flex';
    }

    function switchToManagerView() {
        state.activeServerId = null;
        dashboardView.style.display = 'none';
        sidebar.style.display = 'none';
        serverManagerView.style.display = 'block';
        renderServerManagerList();
    }

    function renderSidebarServerList() {
        sidebarServerListUl.innerHTML = getServers().map(server => `
            <li class="${server.id === state.activeServerId ? 'active' : ''}" onclick="connectToServer('${server.id}')">
                ${server.name}
            </li>
        `).join('');
    }

    async function loadDashboardData() {
        const server = getServers().find(s => s.id === state.activeServerId);
        document.getElementById('dashboard-title').textContent = `Server Info: ${server.name}`;

        const infoPromise = apiCall('/api/info');
        const usersPromise = apiCall('/api/users');
        const [info, users] = await Promise.all([infoPromise, usersPromise]);

        if (info && info.success) renderServerInfo(info.data);
        if (users && users.success) renderUserList(users.data);
    }

    // --- USER MANAGEMENT (from previous implementation, slightly adapted) ---
    const userModal = document.getElementById('user-modal');
    const userModalTitle = document.getElementById('user-modal-title');
    const usernameInput = document.getElementById('username');
    const daysInput = document.getElementById('days');
    const saveUserBtn = document.getElementById('save-user-btn');
    const closeUserModalBtn = document.getElementById('close-user-modal');
    let isRenew = false;

    document.getElementById('show-add-user-modal-btn').addEventListener('click', () => {
        isRenew = false;
        userModalTitle.textContent = 'Add New User';
        usernameInput.value = '';
        usernameInput.disabled = false;
        daysInput.value = '30';
        userModal.style.display = 'flex';
    });

    window.showRenewModal = function(username) {
        isRenew = true;
        userModalTitle.textContent = `Renew User: ${username}`;
        usernameInput.value = username;
        usernameInput.disabled = true;
        daysInput.value = '30';
        userModal.style.display = 'flex';
    }

    closeUserModalBtn.addEventListener('click', () => userModal.style.display = 'none');

    saveUserBtn.addEventListener('click', async () => {
        const password = usernameInput.value.trim();
        const days = parseInt(daysInput.value.trim(), 10);
        if (!password || !days || days <= 0) {
            showToast('Please enter a valid username and number of days.');
            return;
        }

        setButtonLoading(saveUserBtn, true, 'Saving...');
        const endpoint = isRenew ? '/api/user/renew' : '/api/user/create';
        const result = await apiCall(endpoint, 'POST', { password, days });
        setButtonLoading(saveUserBtn, false, 'Save');

        if (result && result.success) {
            showToast(result.message);
            loadDashboardData();
            userModal.style.display = 'none';
        } else {
            showToast(result ? result.message : 'An error occurred.');
        }
    });

    window.deleteUserAction = async function(username) {
        if (confirm(`Are you sure you want to delete user: ${username}?`)) {
            const result = await apiCall('/api/user/delete', 'POST', { password: username });
            if (result && result.success) {
                showToast('User deleted successfully.');
                loadDashboardData();
            } else {
                showToast(result ? result.message : 'Failed to delete user.');
            }
        }
    }

    window.copyUserAction = async function(username, expired) {
        const serverInfo = await apiCall('/api/info');
        if (serverInfo && serverInfo.success) {
            const data = serverInfo.data;
            const infoString = `ZiVPN Account\n-------------------\nServer: ${data.domain || data.public_ip}\nPort: ${data.port}\nPassword: ${username}\nExpired: ${expired}\n-------------------`;
            navigator.clipboard.writeText(infoString).then(() => showToast('Account info copied!'), () => showToast('Failed to copy.'));
        }
    }

    function renderServerInfo(data) {
        document.getElementById('server-info').innerHTML = `<p><strong>Domain:</strong> ${data.domain}</p><p><strong>Public IP:</strong> ${data.public_ip}</p><p><strong>UDP Port:</strong> ${data.port}</p>`;
    }
    function renderUserList(users) {
         document.getElementById('user-list').innerHTML = `
            <table>
                <thead><tr><th>Username</th><th>Expired</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody>
                    ${(users || []).map(user => `
                        <tr>
                            <td>${user.password}</td><td>${user.expired}</td><td>${user.status}</td>
                            <td class="actions">
                                <button class="btn btn-sm" onclick="showRenewModal('${user.password}')">Renew</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUserAction('${user.password}')">Delete</button>
                                <button class="btn btn-sm btn-secondary" onclick="copyUserAction('${user.password}', '${user.expired}')">Copy</button>
                            </td>
                        </tr>`).join('')}
                </tbody>
            </table>`;
    }

    // --- Make functions globally accessible ---
    window.openServerModal = openServerModal;

    // --- EVENT LISTENERS (Manage Servers Button) ---
    document.getElementById('manage-servers-btn').addEventListener('click', switchToManagerView);

    // --- INITIALIZATION ---
    function initialize() {
        renderServerManagerList();
    }

    initialize();
});
</script>

</body>
</html>
